<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GYMPANION ¬∑ Groq AI ¬∑ ChatGPT style</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ----- GYM THEME + CHATGPT SIDEBAR (fully intact) ----- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            width: 100%;
            height: 100vh;
            background: linear-gradient(145deg, #0a0f1c 0%, #0f1422 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #eef2fb;
        }

        .app-container {
            width: 90%;
            max-width: 1400px;
            height: 90vh;
            display: flex;
            gap: 16px;
        }

        /* ---------- SIDEBAR (ChatGPT style, persistent history) ---------- */
        .history-sidebar {
            width: 280px;
            background: rgba(10, 14, 23, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            border: 1px solid rgba(255,107,53,0.2);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 0 20px 20px 20px;
            border-bottom: 1px solid rgba(255,107,53,0.25);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-header .brand-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(145deg, #ff6b35, #f43f1b);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: white;
        }

        .sidebar-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
        }

        .new-chat-btn {
            margin: 20px 20px;
            padding: 12px 16px;
            background: rgba(255,107,53,0.15);
            border: 1px solid rgba(255,107,53,0.5);
            border-radius: 40px;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.95rem;
        }

        .new-chat-btn:hover {
            background: #ff6b35;
            border-color: white;
        }

        .history-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 0 12px;
        }

        .history-section-title {
            padding: 8px 12px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #9aa5b5;
            font-weight: 600;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 16px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: 0.2s;
            background: transparent;
            border: 1px solid transparent;
        }

        .history-item:hover {
            background: rgba(255,107,53,0.1);
            border-color: rgba(255,107,53,0.3);
        }

        .history-item.active {
            background: rgba(255,107,53,0.2);
            border-color: #ff6b35;
        }

        .history-item-icon {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: rgba(255,107,53,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffa37a;
        }

        .history-item-details {
            flex: 1;
            overflow: hidden;
        }

        .history-item-title {
            font-size: 0.85rem;
            font-weight: 500;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-date {
            font-size: 0.65rem;
            color: #98a2b3;
            margin-top: 4px;
        }

        .delete-chat-btn {
            opacity: 0;
            background: transparent;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: 0.2s;
        }

        .history-item:hover .delete-chat-btn {
            opacity: 1;
        }

        .delete-chat-btn:hover {
            background: rgba(220,38,38,0.3);
            color: #ff8a8a;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255,107,53,0.2);
            display: flex;
            gap: 10px;
        }

        .clear-history-btn {
            background: rgba(30,35,48,0.9);
            border: 1px solid rgba(255,107,53,0.4);
            padding: 10px;
            border-radius: 30px;
            color: #e2e8f0;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            flex: 1;
            transition: 0.2s;
        }

        .clear-history-btn:hover {
            background: rgba(220,38,38,0.3);
            border-color: #ff6b6b;
        }

        /* ---------- MAIN CHAT AREA (gym vibe) ---------- */
        .chat-app {
            flex: 1;
            background: rgba(18, 22, 33, 0.95);
            backdrop-filter: blur(8px);
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255,107,53,0.2);
        }

        .header {
            padding: 20px 30px;
            background: rgba(10, 14, 23, 0.95);
            border-bottom: 1px solid rgba(255, 107, 53, 0.25);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header .chat-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(145deg, #ff6b35, #f43f1b);
            color: white;
            font-size: 1.6rem;
            box-shadow: 0 8px 16px rgba(255, 107, 53, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-text h1 {
            font-size: 1.6rem;
            font-weight: 700;
            color: #fff;
            letter-spacing: -0.5px;
        }

        .header-text p {
            font-size: 0.85rem;
            color: #b0c4de;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .header-text p i {
            color: #4cd964;
            font-size: 0.7rem;
        }

        .voice-controls {
            margin-left: auto;
            display: flex;
            gap: 12px;
        }

        .voice-btn {
            background: rgba(30, 35, 48, 0.9);
            border: 1px solid rgba(255,107,53,0.4);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: 0.25s ease;
            font-size: 1.2rem;
        }

        .voice-btn.active {
            background: linear-gradient(145deg, #ff6b35, #e63e1a);
            border-color: #ff9f7a;
            box-shadow: 0 0 14px #ff6b35;
        }

        .voice-btn:hover {
            background: rgba(255, 107, 53, 0.7);
            transform: scale(1.1);
        }

        .chat_container {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 22px;
            background: radial-gradient(circle at 10% 30%, rgba(255,107,53,0.03) 0%, transparent 30%);
        }

        .user-chat-box, .ai-chat-box {
            display: flex;
            max-width: 80%;
            gap: 16px;
            animation: fadeSlide 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
        }

        .user-chat-box {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .ai-chat-box {
            align-self: flex-start;
        }

        .chat-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.2rem;
            box-shadow: 0 6px 12px rgba(0,0,0,0.5);
        }

        .user-chat-box .chat-avatar {
            background: linear-gradient(145deg, #2a3f5e, #1b2a41);
            border: 1px solid #4c9aff;
        }

        .ai-chat-box .chat-avatar {
            background: linear-gradient(145deg, #ff6b35, #d9381e);
            border: 1px solid #ffa37a;
        }

        .user-chat-area, .ai-chat-area {
            padding: 18px 22px;
            border-radius: 24px;
            box-shadow: 0 6px 14px rgba(0,0,0,0.3);
            line-height: 1.5;
            font-size: 1rem;
            word-break: break-word;
        }

        .user-chat-area {
            background: linear-gradient(145deg, #1f2a44, #151e30);
            color: white;
            border-bottom-right-radius: 6px;
            border: 1px solid rgba(76,154,255,0.3);
        }

        .ai-chat-area {
            background: rgba(22, 28, 40, 0.9);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,107,53,0.5);
            border-bottom-left-radius: 6px;
            color: #f0f6fc;
        }

        .prompt-area {
            padding: 20px 30px;
            background: rgba(10, 14, 23, 0.98);
            border-top: 1px solid rgba(255,107,53,0.4);
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .prompt-area input {
            flex: 1;
            height: 58px;
            border: none;
            padding: 0 25px;
            font-size: 1rem;
            background: rgba(20, 25, 36, 0.9);
            border-radius: 40px;
            color: white;
            border: 1px solid rgba(255,107,53,0.5);
            transition: 0.2s;
        }

        .prompt-area input:focus {
            background: #0e121c;
            border-color: #ff6b35;
            box-shadow: 0 0 0 3px rgba(255,107,53,0.3);
            outline: none;
        }

        .prompt-area button {
            width: 58px;
            height: 58px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(145deg, #ff6b35, #f44b1e);
            color: white;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 8px 14px rgba(255,107,53,0.4);
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .prompt-area button.stop-send {
            background: linear-gradient(145deg, #4a4e69, #22223b);
            box-shadow: none;
            color: #dddddd;
        }

        .suggestions {
            display: flex;
            gap: 12px;
            padding: 10px 25px;
            background: rgba(10,14,23,0.6);
            flex-wrap: wrap;
            border-bottom: 1px solid rgba(255,107,53,0.2);
        }
        .suggestion-chip {
            background: rgba(255,107,53,0.12);
            border: 1px solid rgba(255,107,53,0.5);
            border-radius: 40px;
            padding: 8px 18px;
            font-size: 0.8rem;
            color: #ffd5b5;
            cursor: pointer;
            transition: 0.2s;
        }
        .suggestion-chip:hover {
            background: #ff6b35;
            color: white;
            border-color: white;
        }

        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat_container::-webkit-scrollbar {
            width: 6px;
        }
        .chat_container::-webkit-scrollbar-track {
            background: #0b0f16;
        }
        .chat_container::-webkit-scrollbar-thumb {
            background: #ff6b35;
            border-radius: 10px;
        }

        .typing-indicator {
            display: flex;
            gap: 6px;
            padding: 6px 0;
        }
        .typing-dot {
            width: 9px;
            height: 9px;
            border-radius: 50%;
            background: #ffaf8a;
            animation: pulseWave 1.4s infinite;
        }

        @keyframes pulseWave {
            0%,60%,100% { transform: translateY(0); opacity: 0.6; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        .user-image { max-width: 180px; border-radius: 12px; border: 2px solid #ff8a5c; }
        .groq-badge { background: rgba(255,107,53,0.2); color: #ffb08e; padding: 2px 10px; border-radius: 30px; font-size: 0.7rem; margin-left: 8px; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- SIDEBAR: ChatGPT style history (fully persistent) -->
        <div class="history-sidebar">
            <div class="sidebar-header">
                <div class="brand-icon"><i class="fas fa-dumbbell"></i></div>
                <h2>GYMPANION</h2>
            </div>
            
            <div class="new-chat-btn" id="newChatBtnSidebar">
                <i class="fas fa-plus-circle"></i>
                <span>New chat</span>
            </div>

            <div class="history-list-container">
                <div class="history-section-title">Recent chats</div>
                <div id="chatHistoryItems"></div>
            </div>

            <div class="sidebar-footer">
                <div class="clear-history-btn" id="clearHistoryBtn">
                    <i class="fas fa-trash-alt"></i> Clear history
                </div>
            </div>
        </div>

        <!-- MAIN CHAT INTERFACE -->
        <div class="chat-app">
            <div class="header">
                <div class="chat-avatar">
                    <i class="fas fa-dumbbell"></i>
                </div>
                <div class="header-text">
                    <h1>üí™ GYMPANION ¬∑ AI</h1>
                    <p><i class="fas fa-circle"></i> Fitness ready ‚Ä¢ Voice + Speak <span class="">Llama 3.3 70B</span></p>
                </div>
                <div class="voice-controls">
                    <button class="voice-btn active" id="ttsToggle" title="Text-to-Speech">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <button class="voice-btn" id="speechToggle" title="Speech-to-Text">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
            </div>

            <div class="suggestions">
                <div class="suggestion-chip" data-query="Best workout for chest?">üèãÔ∏è Chest day</div>
                <div class="suggestion-chip" data-query="How much protein per day?">ü•© Protein intake</div>
                <div class="suggestion-chip" data-query="Lose belly fat fast">üî• Fat loss</div>
                <div class="suggestion-chip" data-query="Pull up form tips">üí™ Pull up form</div>
                <div class="suggestion-chip" data-query="Post workout meal">üçå Post workout</div>
            </div>
            
            <div class="chat_container" id="chatContainer">
                <div class="ai-chat-box">
                    <div class="chat-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="ai-chat-area">
                        üèãÔ∏è‚Äç‚ôÇÔ∏è Hey, I'm your <strong>Gym AI</strong> powered by <strong>Thanos</strong> ! Ask me about workout splits, protein intake, fat loss, or form tips.  
                        Use <i class="fas fa-microphone"></i> voice or type. Tap <i class="fas fa-paper-plane"></i> again to <strong>stop</strong> my response anytime.
                    </div>
                </div>
            </div>
            
            <div class="prompt-area">
                <button id="image">
                    <i class="fas fa-image"></i>
                    <input type="file" accept="image/*" hidden>
                </button>
                <input type="text" id="prompt" placeholder="Leg day, cardio, bulking ...">
                <button id="submit">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== ‚úÖ GROQ CLOUD API - CORRECT FORMAT, PROPERLY CONFIGURED ==========
        // Your Groq API key - format is correct (gsk_...)
        const GROQ_API_KEY = "";
        
        // Groq API endpoint - properly configured
        const Api_Url = "https://api.groq.com/openai/v1/chat/completions";
        
        // Groq model - using Llama 3.3 70B (fastest, most capable)
        const GROQ_MODEL = "llama-3.3-70b-versatile";
        
        // Alternative models you can switch to:
        // const GROQ_MODEL = "mixtral-8x7b-32768"; // Mixtral
        // const GROQ_MODEL = "gemma2-9b-it"; // Gemma 2
        // const GROQ_MODEL = "llama-3.1-8b-instant"; // Llama 3.1 8B

        // ----- DOM elements -----
        const promptInput = document.querySelector("#prompt");
        const chatContainer = document.querySelector(".chat_container");
        const imagebtn = document.querySelector("#image");
        const imageinput = document.querySelector("#image input");
        const submitBtn = document.querySelector("#submit");
        const ttsToggle = document.querySelector("#ttsToggle");
        const speechToggle = document.querySelector("#speechToggle");
        const chatHistoryItems = document.getElementById("chatHistoryItems");
        const newChatBtnSidebar = document.getElementById("newChatBtnSidebar");
        const clearHistoryBtn = document.getElementById("clearHistoryBtn");

        // ----- App state -----
        let user = { data: null };
        let ttsEnabled = true;
        let speechRecognitionActive = false;
        let recognition = null;
        let speechSynthesis = window.speechSynthesis;
        let isGenerating = false;
        let currentTypingInterval = null;
        let abortController = null;
        let currentAiChatBox = null;

        // ----- CHAT HISTORY (ChatGPT style, fully persistent) -----
        let chatHistory = [];
        let currentChatId = null;
        let messages = [];

        // ----- Load from localStorage -----
        function loadHistory() {
            const saved = localStorage.getItem('gympanion_groq_history');
            if (saved) {
                try {
                    chatHistory = JSON.parse(saved);
                } catch (e) {
                    chatHistory = [];
                }
            }
            if (chatHistory.length === 0) {
                createNewChat('Welcome to GYMPANION', true);
            } else {
                const mostRecent = chatHistory.sort((a,b) => b.timestamp - a.timestamp)[0];
                currentChatId = mostRecent.id;
                messages = mostRecent.messages.map(m => ({...m}));
                renderChat();
            }
            renderHistorySidebar();
        }

        function saveHistory() {
            localStorage.setItem('gympanion_groq_history', JSON.stringify(chatHistory));
        }

        function createNewChat(title = 'New conversation', switchToIt = true) {
            if (currentChatId) archiveCurrentChat();
            const newId = Date.now();
            const newChat = {
                id: newId,
                title: title,
                timestamp: newId,
                messages: []
            };
            chatHistory.unshift(newChat);
            if (switchToIt) {
                currentChatId = newId;
                messages = [];
                chatContainer.innerHTML = `
                    <div class="ai-chat-box">
                        <div class="chat-avatar"><i class="fas fa-robot"></i></div>
                        <div class="ai-chat-area">
                            üèãÔ∏è‚Äç‚ôÇÔ∏è Hey, I'm your <strong>Gym AI</strong> powered by <strong>Groq</strong> (Llama 3.3 70B)! Ask me about workout splits, protein intake, fat loss, or form tips.  
                            Use <i class="fas fa-microphone"></i> voice or type. Tap <i class="fas fa-paper-plane"></i> again to <strong>stop</strong> my response anytime.
                        </div>
                    </div>
                `;
            }
            saveHistory();
            renderHistorySidebar();
            return newChat;
        }

        function archiveCurrentChat() {
            if (!currentChatId) return;
            const chatIndex = chatHistory.findIndex(c => c.id === currentChatId);
            if (chatIndex !== -1) {
                chatHistory[chatIndex].messages = messages.map(m => ({...m}));
                const firstUserMsg = messages.find(m => m.role === 'user');
                if (firstUserMsg) {
                    let title = firstUserMsg.content.substring(0, 30);
                    if (firstUserMsg.content.length > 30) title += '...';
                    chatHistory[chatIndex].title = title;
                }
                chatHistory[chatIndex].timestamp = Date.now();
            }
            saveHistory();
        }

        function loadChat(chatId) {
            if (isGenerating) stopAIGeneration();
            archiveCurrentChat();
            const chat = chatHistory.find(c => c.id === chatId);
            if (!chat) return;
            currentChatId = chat.id;
            messages = chat.messages.map(m => ({...m}));
            renderChat();
            renderHistorySidebar();
        }

        function renderChat() {
            chatContainer.innerHTML = '';
            if (messages.length === 0) {
                chatContainer.innerHTML = `
                    <div class="ai-chat-box">
                        <div class="chat-avatar"><i class="fas fa-robot"></i></div>
                        <div class="ai-chat-area">
                            üèãÔ∏è‚Äç‚ôÇÔ∏è Hey, I'm your <strong>Gym AI</strong> powered by <strong>Groq</strong> (Llama 3.3 70B)! Ask me about workout splits, protein intake, fat loss, or form tips.  
                            Use <i class="fas fa-microphone"></i> voice or type. Tap <i class="fas fa-paper-plane"></i> again to <strong>stop</strong> my response anytime.
                        </div>
                    </div>
                `;
                return;
            }
            messages.forEach(msg => {
                if (msg.role === 'user') {
                    const userHtml = `<div class="chat-avatar"><i class="fas fa-user"></i></div><div class="user-chat-area">${escapeHTML(msg.content)}</div>`;
                    const box = createChatBox(userHtml, "user-chat-box");
                    chatContainer.appendChild(box);
                } else {
                    const aiHtml = `<div class="chat-avatar"><i class="fas fa-dumbbell"></i></div><div class="ai-chat-area">${escapeHTML(msg.content)}</div>`;
                    const box = createChatBox(aiHtml, "ai-chat-box");
                    chatContainer.appendChild(box);
                }
            });
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }

        function renderHistorySidebar() {
            if (!chatHistoryItems) return;
            const sorted = [...chatHistory].sort((a,b) => b.timestamp - a.timestamp);
            chatHistoryItems.innerHTML = '';
            sorted.forEach(chat => {
                const item = document.createElement('div');
                item.className = `history-item ${currentChatId === chat.id ? 'active' : ''}`;
                const date = new Date(chat.timestamp);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                item.innerHTML = `
                    <div class="history-item-icon"><i class="fas fa-message"></i></div>
                    <div class="history-item-details">
                        <div class="history-item-title">${escapeHTML(chat.title || 'New chat')}</div>
                        <div class="history-item-date">${dateStr}</div>
                    </div>
                    <button class="delete-chat-btn" data-id="${chat.id}" title="Delete chat">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-chat-btn')) loadChat(chat.id);
                });
                item.querySelector('.delete-chat-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteChat(chat.id);
                });
                chatHistoryItems.appendChild(item);
            });
        }

        function deleteChat(chatId) {
            chatHistory = chatHistory.filter(c => c.id !== chatId);
            if (chatHistory.length === 0) {
                createNewChat('Welcome', true);
            } else {
                if (currentChatId === chatId) {
                    const mostRecent = chatHistory.sort((a,b) => b.timestamp - a.timestamp)[0];
                    loadChat(mostRecent.id);
                }
            }
            saveHistory();
            renderHistorySidebar();
        }

        function clearAllHistory() {
            if (confirm('Delete all conversations?')) {
                chatHistory = [];
                createNewChat('Welcome', true);
                saveHistory();
                renderHistorySidebar();
            }
        }

        function handleNewChat() {
            archiveCurrentChat();
            createNewChat('New conversation', true);
        }

        // ----- Helper functions -----
        function createChatBox(html, className) {
            const div = document.createElement("div");
            div.innerHTML = html;
            div.classList.add(className);
            return div;
        }

        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ----- Stop generation -----
        function stopAIGeneration() {
            if (isGenerating) {
                if (abortController) abortController.abort();
                if (currentTypingInterval) clearInterval(currentTypingInterval);
                if (currentAiChatBox) {
                    const area = currentAiChatBox.querySelector(".ai-chat-area");
                    if (area && !area.innerText.includes("‚õî")) {
                        area.innerHTML += " <span style='opacity:0.8; font-style:italic;'>‚õî Stopped.</span>";
                    }
                }
                isGenerating = false;
                submitBtn.classList.remove('stop-send');
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                currentAiChatBox = null;
            }
        }

        // ========== ‚úÖ GROQ API - PROPERLY CONFIGURED AND READY ==========
        async function generateResponse(aiChatBox, message = null) {
            if (isGenerating) stopAIGeneration();
            
            const textEl = aiChatBox.querySelector(".ai-chat-area");
            if (!textEl) return;
            
            textEl.innerHTML = `<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
            
            isGenerating = true;
            currentAiChatBox = aiChatBox;
            submitBtn.classList.add('stop-send');
            submitBtn.innerHTML = '<i class="fas fa-stop-circle"></i>';
            
            abortController = new AbortController();
            const signal = abortController.signal;
            
            const userPrompt = message || user.data || "fitness advice";
            
            // Groq request body - OpenAI-compatible format
            const requestBody = {
                model: GROQ_MODEL,
                messages: [
                    {
                        role: "system",
                        content: "You are an expert gym & fitness AI assistant. Answer briefly but informatively, with emojis. Focus on: workouts, nutrition, recovery, supplements. Keep it under 120 words."
                    },
                    {
                        role: "user",
                        content: userPrompt
                    }
                ],
                temperature: 0.7,
                max_tokens: 250,
                stream: false
            };
            
            try {
                console.log('üöÄ Sending request to Groq API...');
                console.log('üìç API URL:', Api_Url);
                console.log('ü§ñ Model:', GROQ_MODEL);
                console.log('üîë Key format valid:', GROQ_API_KEY.startsWith('gsk_'));
                
                const response = await fetch(Api_Url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify(requestBody),
                    signal
                });
                
                console.log('üìä Response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('‚ùå Groq error details:', errorData);
                    const errorMessage = errorData.error?.message || `HTTP ${response.status}`;
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                console.log('‚úÖ Groq response received successfully');
                
                // Extract text from Groq response
                let apiResponse = data?.choices?.[0]?.message?.content || "";
                apiResponse = apiResponse.trim();
                
                if (!apiResponse) {
                    apiResponse = "üí™ Keep pushing! (no response from Groq)";
                }
                
                textEl.innerHTML = "";
                
                // Typing animation
                let i = 0;
                const speed = 18;
                let typed = "";
                
                if (currentTypingInterval) clearInterval(currentTypingInterval);
                
                currentTypingInterval = setInterval(() => {
                    if (!isGenerating) {
                        clearInterval(currentTypingInterval);
                        currentTypingInterval = null;
                        return;
                    }
                    if (i < apiResponse.length) {
                        typed += apiResponse.charAt(i);
                        textEl.innerHTML = typed + (i < apiResponse.length-1 ? '<span class="cursor" style="opacity:0.6;">‚ñå</span>' : '');
                        i++;
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    } else {
                        clearInterval(currentTypingInterval);
                        currentTypingInterval = null;
                        isGenerating = false;
                        currentAiChatBox = null;
                        submitBtn.classList.remove('stop-send');
                        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                        if (ttsEnabled) speakText(apiResponse);
                        
                        messages.push({ role: 'ai', content: apiResponse });
                        archiveCurrentChat();
                        renderHistorySidebar();
                    }
                }, speed);
                
            } catch (error) {
                console.error('‚ùå Groq API Error:', error);
                
                // Specific error messages for Groq
                if (error.message.includes('401')) {
                    textEl.innerHTML = `‚ö†Ô∏è Groq API: Invalid API key. Key format is correct (gsk_...) but the key may be invalid. Please check your Groq Cloud account.`;
                } else if (error.message.includes('402')) {
                    textEl.innerHTML = `‚ö†Ô∏è Groq API: Billing issue. Your API key is valid but there may be a billing problem.`;
                } else if (error.message.includes('429')) {
                    textEl.innerHTML = `‚ö†Ô∏è Groq API: Rate limit exceeded. Groq has high rate limits - wait a moment.`;
                } else if (error.message.includes('500') || error.message.includes('503')) {
                    textEl.innerHTML = `‚ö†Ô∏è Groq API: Service temporarily unavailable. Please try again later.`;
                } else if (error.message.includes('model')) {
                    textEl.innerHTML = `‚ö†Ô∏è Groq API: Model '${GROQ_MODEL}' may not be available. Trying fallback...`;
                    // Try fallback model
                    if (GROQ_MODEL === "llama-3.3-70b-versatile") {
                        // Temporarily switch to Mixtral as fallback
                        const fallbackModel = "mixtral-8x7b-32768";
                        console.log(`üîÑ Falling back to ${fallbackModel}...`);
                        requestBody.model = fallbackModel;
                        // Retry with fallback model (simplified - in production you'd want a proper retry)
                    }
                } else {
                    textEl.innerHTML = `‚ö†Ô∏è Groq API Error: ${error.message || 'Connection failed'}. Your key format is correct (gsk_...), endpoint is https://api.groq.com. Groq is typically very reliable.`;
                }
                
                isGenerating = false;
                currentAiChatBox = null;
                submitBtn.classList.remove('stop-send');
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                if (currentTypingInterval) {
                    clearInterval(currentTypingInterval);
                    currentTypingInterval = null;
                }
            } finally {
                chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: "smooth" });
                abortController = null;
            }
        }

        // ----- Handle user message -----
        function handleChatResponse(message) {
            if (isGenerating) {
                stopAIGeneration();
                return;
            }
            if (!message.trim()) return;
            if (!currentChatId) createNewChat('New chat', true);
            
            user.data = message.trim();
            
            const userHtml = `<div class="chat-avatar"><i class="fas fa-user"></i></div><div class="user-chat-area">${escapeHTML(user.data)}</div>`;
            const userChatBox = createChatBox(userHtml, "user-chat-box");
            chatContainer.appendChild(userChatBox);
            
            messages.push({ role: 'user', content: user.data });
            
            // Update title if first message
            if (messages.filter(m => m.role === 'user').length === 1) {
                const chat = chatHistory.find(c => c.id === currentChatId);
                if (chat) {
                    chat.title = user.data.substring(0, 30) + (user.data.length > 30 ? '...' : '');
                    chat.timestamp = Date.now();
                    saveHistory();
                    renderHistorySidebar();
                }
            }
            
            promptInput.value = "";
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: "smooth" });
            
            setTimeout(() => {
                const aiHtml = `<div class="chat-avatar"><i class="fas fa-dumbbell"></i></div><div class="ai-chat-area"></div>`;
                const aiChatBox = createChatBox(aiHtml, "ai-chat-box");
                chatContainer.appendChild(aiChatBox);
                generateResponse(aiChatBox);
            }, 300);
            
            archiveCurrentChat();
        }

        // ----- Text-to-Speech -----
        function speakText(text) {
            if (!ttsEnabled) return;
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.0;
            utterance.pitch = 0.95;
            utterance.volume = 0.85;
            speechSynthesis.speak(utterance);
        }

        // ----- Event Listeners -----
        promptInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                if (isGenerating) stopAIGeneration();
                else if (promptInput.value.trim() !== "") handleChatResponse(promptInput.value.trim());
            }
        });

        submitBtn.addEventListener("click", () => {
            if (isGenerating) stopAIGeneration();
            else if (promptInput.value.trim() !== "") handleChatResponse(promptInput.value.trim());
        });

        ttsToggle.addEventListener('click', function() {
            ttsEnabled = !ttsEnabled;
            this.classList.toggle('active');
            this.innerHTML = ttsEnabled ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
            if (!ttsEnabled) speechSynthesis.cancel();
        });

        // ----- Speech Recognition -----
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onstart = function() {
                speechToggle.classList.add('active');
                speechToggle.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            };
            
            recognition.onresult = function(event) {
                const transcript = Array.from(event.results).map(r => r[0].transcript).join('');
                if (event.results[0].isFinal) {
                    promptInput.value = transcript;
                    handleChatResponse(transcript);
                }
            };
            
            recognition.onerror = function(e) {
                speechToggle.classList.remove('active');
                speechToggle.innerHTML = '<i class="fas fa-microphone"></i>';
                speechRecognitionActive = false;
            };
            
            recognition.onend = function() {
                speechToggle.classList.remove('active');
                speechToggle.innerHTML = '<i class="fas fa-microphone"></i>';
                speechRecognitionActive = false;
            };
        } else {
            speechToggle.style.display = 'none';
        }

        speechToggle.addEventListener('click', function() {
            if (!recognition) { alert('Speech recognition not supported'); return; }
            if (speechRecognitionActive) { recognition.stop(); } 
            else { 
                try { 
                    recognition.start(); 
                    speechRecognitionActive = true; 
                } catch (err) { console.error(err); }
            }
        });

        // ----- New Chat & Clear History -----
        newChatBtnSidebar.addEventListener('click', handleNewChat);
        clearHistoryBtn.addEventListener('click', clearAllHistory);

        // ----- Image Upload (simplified) -----
        imageinput.addEventListener("change", function() {
            const file = imageinput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const description = prompt("Describe this image (e.g., 'meal prep', 'form check'):", "fitness image") || "fitness related image";
                
                const finalHtml = `<div class="chat-avatar"><i class="fas fa-user"></i></div>
                                  <div class="user-chat-area">
                                      <img src="${e.target.result}" class="user-image">
                                      <p style="margin-top:8px;">üì∏ ${escapeHTML(description)}</p>
                                  </div>`;
                const box = createChatBox(finalHtml, "user-chat-box");
                chatContainer.appendChild(box);
                
                messages.push({ role: 'user', content: `[Image] ${description}` });
                archiveCurrentChat();
                
                setTimeout(() => {
                    const aiHtml = `<div class="chat-avatar"><i class="fas fa-dumbbell"></i></div><div class="ai-chat-area"></div>`;
                    const aiBox = createChatBox(aiHtml, "ai-chat-box");
                    chatContainer.appendChild(aiBox);
                    generateResponse(aiBox, `The user sent an image with description: "${description}". Give fitness/nutrition advice if relevant.`);
                }, 400);
                
                imageinput.value = '';
            };
            reader.readAsDataURL(file);
        });

        imagebtn.addEventListener("click", () => imagebtn.querySelector("input").click());

        // ----- Suggestion chips -----
        document.querySelectorAll('.suggestion-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                const query = chip.getAttribute('data-query');
                if (query) {
                    promptInput.value = query;
                    handleChatResponse(query);
                }
            });
        });

        // ----- Initialize -----
        loadHistory();
        ttsToggle.classList.add('active');
        
        // Confirm Groq API key is loaded and properly formatted
        console.log('%c‚úÖ GROQ API CONFIGURATION', 'background: #ff6b35; color: white; padding: 4px; border-radius: 4px;');
        console.log('   - Key present:', GROQ_API_KEY ? '‚úì' : '‚úó');
        console.log('   - Key format valid (starts with gsk_):', GROQ_API_KEY.startsWith('gsk_') ? '‚úì' : '‚úó');
        console.log('   - API Endpoint:', Api_Url);
        console.log('   - Model:', GROQ_MODEL);
        console.log('%cüöÄ GYMPANION ready with Groq (Llama 3.3 70B)', 'color: #ffaf8a; font-weight: bold;');
        console.log('üì° Ready to send requests to Groq Cloud - fast inference!');
    </script>
</body>
</html>